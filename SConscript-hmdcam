import os
import platform
import sys
Import('env')

# Building on Tegra; build hmdcam application
tegraEnv = env.Clone()

# Import locally built Monado static libraries
MONADO_BASE='#monado'
MONADO_BUILD='#build/monado'

if not os.path.exists(str(Dir(MONADO_BUILD))):
  sys.exit('Monado build artifacts are not present. Please run ./build-monado.sh first.')

tegraEnv.Append(
  CPPPATH=[
    'hmdcam',
    'wayland',
    MONADO_BUILD + '/src/xrt/include', # Contains generated config headers
    MONADO_BASE + '/src/xrt/include',
    MONADO_BASE + '/src/xrt/auxiliary',
  ]
)
monadoStatics = \
    Glob(MONADO_BUILD + '/src/xrt/targets/common/*.a') + \
    Glob(MONADO_BUILD + '/src/xrt/state_trackers/prober/*.a') + \
    Glob(MONADO_BUILD + '/src/xrt/drivers/*.a') + \
    Glob(MONADO_BUILD + '/src/xrt/state_trackers/oxr/*.a') + \
    [
      MONADO_BUILD + '/src/xrt/auxiliary/os/libaux_os.a',
      MONADO_BUILD + '/src/xrt/auxiliary/util/libaux_util.a',
      MONADO_BUILD + '/src/xrt/auxiliary/util/libaux_util_sink.a',
      MONADO_BUILD + '/src/xrt/auxiliary/vive/libaux_vive.a',
      MONADO_BUILD + '/src/xrt/auxiliary/tracking/libaux_tracking.a', # Needs to be after libaux_vive.a
      MONADO_BUILD + '/src/xrt/auxiliary/math/libaux_math.a', # Needs to be after libaux_tracking.a for symbol resolution.
      MONADO_BUILD + '/src/xrt/auxiliary/bindings/libaux_generated_bindings.a' # Needs to be after libaux_util.a
    ]


liveMediaStatics = [
  '#live555/libliveMedia.a',
  '#live555/libgroupsock.a',
  '#live555/libBasicUsageEnvironment.a',
  '#live555/libUsageEnvironment.a']

# Pull in a few classes from tegra_mmapi
tegra_mmapi_class_src_base = tegraEnv['TEGRA_MMAPI'] + '/samples/common/classes'
VariantDir('tegra_mmapi', tegra_mmapi_class_src_base, duplicate=False)
tegra_mmapi_src = [
  'tegra_mmapi/NvBuffer.cpp',
  'tegra_mmapi/NvElement.cpp',
  'tegra_mmapi/NvElementProfiler.cpp',
  'tegra_mmapi/NvLogging.cpp',
  'tegra_mmapi/NvUtils.cpp',
  'tegra_mmapi/NvV4l2Element.cpp',
  'tegra_mmapi/NvV4l2ElementPlane.cpp',
  'tegra_mmapi/NvVideoDecoder.cpp',
  'tegra_mmapi/NvVideoEncoder.cpp'
]

tegraEnv.Append(LIBS=[
  'z',
  'dl',
  'pthread', 'rt',
  'boost_chrono', 'boost_system', 'boost_thread',
  'epoxy',
  'drm',
  'wayland-client', 'wayland-egl',
  'hidapi-libusb', 'usb-1.0', 'udev',
  'nvargus',
  'nvbuf_utils', 'nvbufsurface', 'nvbufsurftransform',
  'v4l2',
  'cuda', 'cudart',
  'nppc', 'nppidei', 'nppitc',
  'opencv_core', 'opencv_imgproc', 'opencv_calib3d', 'opencv_aruco',
  'ibverbs', 'rdmacm',
])

if (env['HAVE_VPI2']):
  tegraEnv.Append(LIBS=['nvvpi'])
if (env['HAVE_OPENCV_CUDA']):
  tegraEnv.Append(LIBS=['opencv_cudafilters', 'opencv_cudaimgproc', 'opencv_cudawarping'])

tegraEnv.Program(
  target = '../bin/hmdcam', # relative to build/hmdcam
  source = Glob('hmdcam/*.cpp') + Glob('hmdcam/*.c') + Glob('hmdcam/*.cu') + Glob('common/*.cpp') + Glob('common/*.cu') + Glob('rdma/*.cpp') + Glob('rhi/*.cpp') + Glob('rhi/cuda/*.cpp') + Glob('rhi/gl/*.cpp') + Glob('rhi/egl/*.cpp') + Glob('imgui/*.cpp') + Glob('implot/*.cpp') + Glob('wayland/*.c') + tegra_mmapi_src + liveMediaStatics + monadoStatics,
)

